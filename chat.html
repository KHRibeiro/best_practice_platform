<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat 1:1 com Supabase</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
/* Chat sidebar */
.chat-sidebar {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 300px;
  max-height: 70vh;
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  z-index:1050;
}

/* Chat body scroll */
.chat-body {
  overflow-y: auto;
  flex: 1 1 auto;
  background: #fff;
}

/* Input area */
.chat-input { background: #f8f9fa; border-top: 1px solid #eee; }

/* Mensagens */
.msg { margin-bottom: 8px; display:flex; }
.msg.me { justify-content: flex-end; }
.msg .bubble {
  max-width: 70%;
  padding: 8px 12px;
  border-radius: 12px;
  background: #e9ecef;
}
.msg.me .bubble { background: #0d6efd; color:white; }
.msg .meta { font-size: 11px; color:#666; margin-bottom:3px; }

/* Lista de contatos no toast */
#contactsList .list-group-item {
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
}
.status-dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:green;
  flex-shrink:0;
}
</style>
</head>
<body>

<!-- Botão flutuante para mostrar usuários -->
<button id="showUsersBtn" class="btn btn-primary position-fixed" style="bottom:20px; right:20px; z-index:1050;">
  Usuários
</button>

<!-- Toast container no canto inferior direito -->
<div class="position-fixed bottom-0 end-0 mb-5 me-3" style="z-index:1060;">
  <div id="usersToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Online</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Fechar"></button>
    </div>
    <div class="toast-body p-0">
      <ul id="contactsList" class="list-group list-group-flush mb-0"></ul>
    </div>
  </div>
</div>

<!-- Chat lateral direito -->
<div id="chatSidebar" class="chat-sidebar shadow" style="display:none;">
  <div class="chat-header d-flex justify-content-between align-items-center p-2">
    <strong id="chatTitle">Chat</strong>
    <button id="closeChatBtn" class="btn btn-sm btn-light">×</button>
  </div>
  <div id="chatBody" class="chat-body p-2">
    <ul id="messagesList" class="list-unstyled mb-0"></ul>
  </div>
  <form id="chatForm" class="chat-input p-2 d-flex gap-2">
    <input id="chatInput" class="form-control form-control-sm" placeholder="Digite..." />
    <button class="btn btn-primary btn-sm" type="submit">Enviar</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient('https://qnxvprptwczutzojjyve.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio');

  
</script>

<script type="module">

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const SUPABASE_URL = 'https://qnxvprptwczutzojjyve.supabase.co';
	const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)


let userId = null;
let username = null;
let peerId = null;
let usersToast = null;




async function init() {
  
  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    document.getElementById("usuario").innerText = `User: ${user.email}`;
  } else {
    window.location.href = "login.html"; // redireciona se não estiver logado
  }
  
  userId = user.id;
  username = user.email.split("@")[0];

  usersToast = new bootstrap.Toast(document.getElementById('usersToast'), { autohide:false });

  setupPresence();
  setupChatEvents();
  setupUI();
}

function setupPresence() {
  const channel = supabase.channel("online-users", { config:{ presence:{ key:userId } } });

  channel.on("presence", { event:"sync" }, () => {
    renderContacts(channel.presenceState());
  }).subscribe(async status=>{
    if(status==="SUBSCRIBED") channel.track({ userId, username });
  });
}

function renderContacts(state){
  const list = document.getElementById("contactsList");
  list.innerHTML = "";
  for(const [id, sessions] of Object.entries(state)){
    if(id===userId) continue;
    const userInfo = sessions[0];
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.innerHTML = `<span class="status-dot"></span> ${userInfo.username}`;
    li.onclick = ()=>openChat(id, userInfo.username);
    list.appendChild(li);
  }
}

// Chat 1:1
function setupChatEvents(){
  document.getElementById("chatForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const text = document.getElementById("chatInput").value.trim();
    if(!text || !peerId) return;
    const { error } = await supabase.from("messages").insert([{ sender_id:userId, receiver_id:peerId, content:text }]);
    if(error) console.error(error);
    document.getElementById("chatInput").value = "";
  });
  document.getElementById("closeChatBtn").onclick = ()=>{
    document.getElementById("chatSidebar").style.display="none"; peerId=null;
  };
}

function openChat(peer, peerName){
  peerId = peer;
  document.getElementById("chatSidebar").style.display="flex";
  document.getElementById("chatTitle").textContent = "Chat com "+peerName;
  loadHistory(); subscribeRealtime();
}

async function loadHistory(){
  const { data, error } = await supabase.from("messages")
    .select("*")
    .or(`and(sender_id.eq.${userId},receiver_id.eq.${peerId}),and(sender_id.eq.${peerId},receiver_id.eq.${userId})`)
    .order("created_at",{ ascending:true });
  if(error){ console.error(error); return; }
  const list = document.getElementById("messagesList"); list.innerHTML="";
  data.forEach(msg=>addMessage(msg));
}

function subscribeRealtime(){
  supabase.channel("chat-1to1")
    .on("postgres_changes",{ event:"INSERT", schema:"public", table:"messages" }, payload=>{
      const msg=payload.new;
      if((msg.sender_id===userId && msg.receiver_id===peerId) || (msg.sender_id===peerId && msg.receiver_id===userId))
        addMessage(msg);
    }).subscribe();
}

function addMessage(msg){
  const who=msg.sender_id===userId?"me":"other";
  const li=document.createElement("li"); li.className=`msg ${who}`;
  li.innerHTML=`<div><div class="bubble">${escapeHtml(msg.content)}</div><div class="meta">${new Date(msg.created_at).toLocaleTimeString()}</div></div>`;
  document.getElementById("messagesList").appendChild(li);
  document.getElementById("chatBody").scrollTop=document.getElementById("chatBody").scrollHeight;
}

function escapeHtml(unsafe){ return unsafe.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

function setupUI(){
  document.getElementById("showUsersBtn").onclick=()=>usersToast.show();
}

init();
</script>
</body>
</html>
