<!DOCTYPE html>

<html lang="pt-BR">
	
<head>
<link rel="icon" href="simb.ico" type="image/x-icon">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="style.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<title>Mail - Best Practices Platform</title>

<style>

	/* Layout principal em duas colunas */
.layout {
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 200px;
  background-color: #2c3e50;
  padding-top: 60px;
  transition: width 0.3s ease;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
}

.sidebar.collapsed {
  width: 60px;
}

.sidebar a {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  text-decoration: none;
  font-size: 18px;
  color: #fff;
  white-space: nowrap;
  transition: background-color 0.2s;
}

.sidebar a:hover {
  background-color: #575757;
}

.sidebar a span:first-child {
  width: 30px;
  text-align: center;
}

.sidebar .link-text {
  opacity: 1;
  transition: opacity 0.2s ease;
}

.sidebar.collapsed .link-text {
  opacity: 0;
  pointer-events: none;
  width: 0;
  overflow: hidden;
}

/* ConteÃºdo principal */
main {
  flex: 1;
  padding: 20px;
  transition: margin-left 0.3s ease;
  overflow-y: auto;
}

/* BotÃ£o para abrir sidebar */
.openbtn {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1100;
  font-size: 20px;
  cursor: pointer;
  background-color: #2c3e50;
  color: white;
  padding: 10px 15px;
  border: none;
}

	
	body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f8;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    nav {
      background: #34495e;
      padding: 0.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    nav a {
      margin: 0 1em;
      text-decoration: none;
      color: white;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
   
    input[type="text"], select {
      padding: 0.5em;
      margin: 0.5em 0;
      width: 200px;
    }
  </style>

</head>
  
<body>
	
<header>
<img alt="Best Practice Platform Logo" src="jpeg (2).jpg" style="height:150px; background-color:transparent;"/>

<h1>ðŸ“© Caixa de Mensagens</h1>

<div id="usuario" style="text-align:right; padding: 0.5em; font-size: 0.9em; color:white"></div>

</header>

<!-- BotÃ£o de toggle -->
<button onclick="toggleSidebar()" class="openbtn">â˜°</button>

<!-- Container do layout -->
<div class="layout">
  
  <!-- Sidebar -->
  <div id="mySidebar" class="sidebar collapsed">
    <a href="index.html" title="Dashboard">
  <span><i class="bi bi-speedometer2 text-white"></i></span>
  <span class="link-text">Dashboard</span>
</a>

<a href="library.html" title="Library">
  <span><i class="bi bi-journals text-white"></i></span>
  <span class="link-text">Library</span>
</a>

<a href="submission.html" title="Submit">
  <span><i class="bi bi-upload text-white"></i></span>
  <span class="link-text">Submit</span>
</a>

<a href="tracker.html" title="Tracker">
  <span><i class="bi bi-graph-up-arrow text-white"></i></span>
  <span class="link-text">Tracker</span>
</a>

<a href="audit.html" title="Audit">
  <span><i class="bi bi-search text-white"></i></span>
  <span class="link-text">Audit</span>
</a>

<a href="admin.html" title="Admin">
  <span><i class="bi bi-person-gear text-white"></i></span>
  <span class="link-text">Admin</span>
</a>

<a href="login.html" title="Login">
  <span><i class="bi bi-box-arrow-in-right text-white"></i></span>
  <span class="link-text">Login</span>
</a>

    <!-- BotÃ£o logout fixado no rodapÃ© -->
<div class="logout-container">
    <a href="#" id="logoutBtn" title="Logout">
    <span><i class="bi bi-box-arrow-right text-white"></i></span>
    <span class="link-text">Logout</span>
    </a>
</div>

  </div>

<main id="mainContent">
	
  <div class="max-w-4xl mx-auto bg-white shadow rounded-lg p-6">
   
    <div id="user-info" class="mb-4 text-gray-700"></div>

    <!-- FormulÃ¡rio para enviar mensagem -->
    <form id="send-form" class="space-y-2 mb-6">
      <input type="email" id="to" placeholder="Email do destinatÃ¡rio" class="border p-2 w-full rounded" required>
      <input type="text" id="subject" placeholder="Assunto" class="border p-2 w-full rounded" required>
      <textarea id="body" placeholder="Mensagem" class="border p-2 w-full rounded" rows="3" required></textarea>
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Enviar</button>
    </form>

    <div class="grid grid-cols-2 gap-6">
      <!-- Caixa de entrada -->
      <div>
        <h2 class="font-semibold text-lg mb-2">ðŸ“¥ Recebidas</h2>
        <ul id="inbox" class="space-y-2"></ul>
      </div>

      <!-- Enviadas -->
      <div>
        <h2 class="font-semibold text-lg mb-2">ðŸ“¤ Enviadas</h2>
        <ul id="sent" class="space-y-2"></ul>
      </div>
    </div>
  </div>
	
</body> 
</main>

  <script type="module">
   import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = 'https://qnxvprptwczutzojjyve.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;

    async function loadUser() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.getElementById("user-info").innerHTML =
          `<a href="login.html" class="text-blue-500">Fazer login</a>`;
        return;
      }
      currentUser = user;
      document.getElementById("user-info").innerText = `Logado como: ${user.email}`;
      loadMessages();
      setupRealtime();
    }

    async function getUserEmail(uid) {
      if (!uid) return "desconhecido";
      let { data, error } = await supabase.rpc("get_user_email", { uid: uid });
      if (error) {
        console.error("Erro RPC get_user_email:", error);
        return uid;
      }
      return data;
    }

    async function loadMessages() {
      // Recebidas
      let { data: inbox, error: errInbox } = await supabase
        .from("messages")
        .select("id, subject, body, is_read, sender, created_at")
        .eq("receiver", currentUser.id)
        .order("created_at", { ascending: false });

      if (errInbox) console.error("Erro ao carregar inbox:", errInbox);

      let inboxHTML = "";
      for (let m of inbox || []) {
        const senderEmail = await getUserEmail(m.sender);
        inboxHTML += `
          <li class="p-2 border rounded ${m.is_read ? 'bg-gray-100' : 'bg-yellow-100'}">
            <strong>De:</strong> ${senderEmail}<br>
            <strong>Assunto:</strong> ${m.subject}<br>
            <span class="text-sm text-gray-600">${m.body}</span>
            <div class="mt-1 space-x-2">
              <button onclick="replyMessage('${senderEmail}', '${m.subject}')" class="text-blue-500">Responder</button>
              <button onclick="forwardMessage('${m.subject}', '${m.body}')" class="text-green-500">Encaminhar</button>
              <button onclick="deleteMessage('${m.id}')" class="text-red-500">Deletar</button>
            </div>
          </li>`;
      }
      document.getElementById("inbox").innerHTML = inboxHTML;

      // Enviadas
      let { data: sent, error: errSent } = await supabase
        .from("messages")
        .select("id, subject, body, receiver, created_at")
        .eq("sender", currentUser.id)
        .order("created_at", { ascending: false });

      if (errSent) console.error("Erro ao carregar sent:", errSent);

      let sentHTML = "";
      for (let m of sent || []) {
        const receiverEmail = await getUserEmail(m.receiver);
        sentHTML += `
          <li class="p-2 border rounded bg-gray-50">
            <strong>Para:</strong> ${receiverEmail}<br>
            <strong>Assunto:</strong> ${m.subject}<br>
            <span class="text-sm text-gray-600">${m.body}</span>
            <div class="mt-1 space-x-2">
              <button onclick="forwardMessage('${m.subject}', '${m.body}')" class="text-green-500">Encaminhar</button>
              <button onclick="deleteMessage('${m.id}')" class="text-red-500">Deletar</button>
            </div>
          </li>`;
      }
      document.getElementById("sent").innerHTML = sentHTML;
    }

    document.getElementById("send-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const toEmail = document.getElementById("to").value;
      const subject = document.getElementById("subject").value;
      const body = document.getElementById("body").value;

      let { data: users, error } = await supabase.rpc("get_user_by_email", { email: toEmail });
      if (error || !users || users.length === 0) {
        alert("UsuÃ¡rio nÃ£o encontrado.");
        return;
      }

      const receiverId = users[0].id;

      await supabase.from("messages").insert([{
        sender: currentUser.id,
        receiver: receiverId,
        subject,
        body
      }]);

      e.target.reset();
      loadMessages();
    });

    // Responder, encaminhar, deletar
    window.replyMessage = (toEmail, subject) => {
      document.getElementById("to").value = toEmail;
      document.getElementById("subject").value = "Re: " + subject;
      document.getElementById("body").focus();
    }

    window.forwardMessage = (subject, body) => {
      document.getElementById("to").value = "";
      document.getElementById("subject").value = "Fwd: " + subject;
      document.getElementById("body").value = body;
      document.getElementById("body").focus();
    }

    window.deleteMessage = async (messageId) => {
      if (!confirm("Deseja realmente deletar esta mensagem?")) return;
      await supabase.from("messages").delete().eq("id", messageId);
      loadMessages();
    }

    // ðŸ”¹ Configurar Realtime para inbox
    function setupRealtime() {
      supabase
        .channel('public:messages')
        .on(
          'postgres_changes',
          { event: '*', schema: 'public', table: 'messages', filter: `receiver=eq.${currentUser.id}` },
          payload => {
            console.log("Nova mensagem recebida:", payload);
            loadMessages(); // Atualiza lista automaticamente
          }
        )
        .subscribe();
    }

    loadUser();
  </script>
 
</html>
