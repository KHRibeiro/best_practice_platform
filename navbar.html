<!-- navbar.html -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<nav class="navbar bg-light px-3 d-flex justify-content-end">
  <div id="msg-icon" class="position-relative" style="cursor:pointer;">
    <!-- Ícone de envelope -->
    <i class="bi bi-envelope fs-3"></i>

    <!-- Badge de mensagens novas -->
    <span id="msg-badge"
          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
      0
    </span>
  </div>
</nav>

<script type="module">
  // ⚡ Atenção: precisa do supabase já inicializado na página (supabase.createClient(...))

  // Atualiza contador de mensagens novas
  async function loadNewMessagesCount() {
    try {
      const { data, error } = await supabase
        .from("messages")
        .select("id", { count: "exact" })
        .eq("is_read", false);

      if (error) {
        console.error("Erro ao buscar mensagens novas:", error);
        return;
      }

      const count = data.length; // ou use data?.count se preferir
      const badge = document.getElementById("msg-badge");

      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove("d-none");
        } else {
          badge.classList.add("d-none");
        }
      }
    } catch (err) {
      console.error("Falha loadNewMessagesCount:", err);
    }
  }

  // Clique no envelope → abre inbox.html
  document.addEventListener("DOMContentLoaded", () => {
    const icon = document.getElementById("msg-icon");
    if (icon) {
      icon.addEventListener("click", () => {
        window.location.href = "inbox.html";
      });
    }

    // carrega ao abrir a página
    loadNewMessagesCount();

    // atualiza a cada 30s
    setInterval(loadNewMessagesCount, 30000);
  });
</script>
