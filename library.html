<!DOCTYPE html>
<html lang="pt-BR">
<head>
<link rel="icon" href="simb.ico" type="image/x-icon">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="style.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<title>Library - Best Practices Platform</title>

<style>
/* azul suave para fora do mapa */
.leaflet-container { background: #AAD3DF; }

/* Layout principal em duas colunas */
.layout { display: flex; height: 100vh; }

/* Sidebar */
.sidebar {
  width: 200px;
  background-color: #9AB6DE;
  padding-top: 60px;
  transition: width 0.3s ease;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
}
.sidebar.collapsed { width: 60px; }
.sidebar a { display: flex; align-items: center; padding: 12px 16px; text-decoration: none; font-size: 18px; color: #fff; white-space: nowrap; transition: background-color 0.2s; }
.sidebar a:hover { background-color: #575757; }
.sidebar a span:first-child { width: 30px; text-align: center; }
.sidebar .link-text { opacity: 1; transition: opacity 0.2s ease; }
.sidebar.collapsed .link-text { opacity: 0; pointer-events: none; width: 0; overflow: hidden; }

/* Conteúdo principal */
main { flex: 1; padding: 20px; transition: margin-left 0.3s ease; overflow-y: auto; }

/* Botão para abrir sidebar */
.openbtn { position: fixed; top: px; left: px; z-index: 10; font-size: 20px; cursor: pointer; background-color: #9AB6DE; color: white; padding: 10px 15px; border: none; }

body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #9AB6DE; color: white; padding: 1rem; text-align: left; }
nav { background: #34495e; padding: 0.5rem; display: flex; justify-content: center; gap: 1rem; }
nav a { margin: 0 1em; text-decoration: none; color: white; font-weight: bold; }
nav a:hover { text-decoration: underline; }
main { padding: 2em; }
input[type="text"], select { padding: 0.5em; margin: 0.5em 0; width: 200px; }
</style>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<header>
<button onclick="toggleSidebar()" class="openbtn">☰</button>
<div id="usuario" style="text-align:right; padding: 0.5em; font-size: 0.9em; color:white"></div>
</header>

<div class="layout">
  <div id="mySidebar" class="sidebar collapsed">
    <a href="index.html" title="Dashboard"><span><i class="bi bi-speedometer2 text-white"></i></span><span class="link-text">Dashboard</span></a>
    <a href="library.html" title="Library"><span><i class="bi bi-journals text-white"></i></span><span class="link-text">Library</span></a>
    <a href="submission.html" title="Submit"><span><i class="bi bi-upload text-white"></i></span><span class="link-text">Submit</span></a>
    <a href="tracker.html" title="Tracker"><span><i class="bi bi-graph-up-arrow text-white"></i></span><span class="link-text">Tracker</span></a>
    <a href="audit.html" title="Audit"><span><i class="bi bi-search text-white"></i></span><span class="link-text">Audit</span></a>
    <a href="admin.html" title="Admin"><span><i class="bi bi-person-gear text-white"></i></span><span class="link-text">Admin</span></a>
    <a href="login.html" title="Login"><span><i class="bi bi-box-arrow-in-right text-white"></i></span><span class="link-text">Login</span></a>
    <a href="mail.html" title="Mensagens"><span><i class="bi bi-envelope-fill text-white"></i></span><span class="link-text">Mensagens</span></a>
    <div class="logout-container">
      <a href="#" id="logoutBtn" title="Logout"><span><i class="bi bi-box-arrow-right text-white"></i></span><span class="link-text">Logout</span></a>
    </div>
  </div>

  <main id="mainContent">
    <h2>Library</h2>

    <section id="data-section">
      <form class="row g-3 needs-validation" novalidate>
        <div class="col-md-3">
          <label class="form-label">Keywords: </label>
          <input id="searchInput" class="form-control" onkeyup="applyFilters()" placeholder="Keywords..." type="text"/>
        </div>
        <div class="col-md-3">
          <label for="filter-category" class="form-label">Category:</label>
          <select id="filter-category" class="form-select" onchange="applyFilters()">
            <option value="">All</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-status">Status:</label>
          <select id="filter-status" class="form-select" onchange="applyFilters()">
            <option value="">All</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="filter-location">Region/Site:</label>
          <select id="filter-location" class="form-select" onchange="applyFilters()">
            <option value="">All</option>
          </select>
        </div>
      </form>
      
      <div id="table-info" class="mb-2 text-muted"></div>
      <table id="results-table" class="table table-hover">
        <thead>
          <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Region/Site</th>
            <th>Responsible</th>
            <th>Status</th>
            <th>Files</th>
            <th>Details</th>
            <th>Type</th>
            <th>Implement</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="pagination" class="d-flex justify-content-center mt-3"></div>

      <div id="map" style="height: 350px; margin-top: 20px;"></div>
    </section>
  </main>
</div>

<script>
function toggleSidebar() {
  const sidebar = document.getElementById("mySidebar");
  sidebar.classList.toggle("collapsed");
}
</script>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://qnxvprptwczutzojjyve.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Funções que são usadas por botões inline devem ser expostas em window
window.selecionarAtividade = async function(botao) {
  const linha = botao.closest("tr");
  const titulo = linha.cells[0].innerText;
  const categoria = linha.cells[1].innerText;
  const localizacao = linha.cells[2].innerText;
  const responsavel = linha.cells[3].innerText;
  const status = linha.cells[4].innerText;
  const detalhes_link = linha.cells[6].querySelector('a')?.href || '';
  const id = new URL(detalhes_link, window.location.origin).searchParams.get('id');

  if (!id) { alert("ID da submissão não encontrado."); return; }

  const { data, error } = await supabase
    .from('submissions')
    .select('description, functional_area, applicability, steps')
    .eq('id', id)
    .single();

  if (error || !data) { console.error("Erro ao buscar dados adicionais:", error); alert("Erro ao buscar dados da submissão."); return; }

  const { description, functional_area, applicability, steps } = data;

  const { error: insertError } = await supabase
    .from('atividades_selecionadas')
    .insert([{
      titulo, categoria, localizacao, responsavel, status,
      description, functional_area, applicability, steps
    }]);

  if (insertError) {
    console.error("Erro ao enviar:", insertError);
    alert("Erro ao enviar atividade.");
  } else {
    alert("Atividade enviada com sucesso!");
    botao.disabled = true;
    botao.classList.remove("btn-primary");
    botao.classList.add("btn-secondary");
  }
};

window.removerLinha = async function(id) {
  try {
    // 1️⃣ Buscar a submissão para identificar a região/localização
    const { data: submission, error: fetchError } = await supabase
      .from('submissions')
      .select('region_plant')
      .eq('id', id)
      .single();

    if (fetchError || !submission) {
      alert('Erro ao buscar a submissão: ' + (fetchError?.message || 'Submissão não encontrada'));
      return;
    }

    const { localizacao } = submission;

    // 2️⃣ Deletar a submissão
    const { error: deleteError } = await supabase
      .from('submissions')
      .delete()
      .eq('id', id);

    if (deleteError) {
      alert('Erro ao remover a submissão: ' + deleteError.message);
      return;
    }

    // 3️⃣ Atualizar pontos da localidade (-50)
    const { data: locData, error: locError } = await supabase
      .from('location')
      .select('points')
      .eq('region_plantloc', localizacao) // ajuste se a coluna tiver outro nome
      .single();

    if (locError || !locData) {
      console.warn('Erro ao buscar dados da localidade:', locError);
    } else {
      const newPoints = Math.max((locData.points || 0) - 50, 0); // evita pontos negativos
      const { error: updateError } = await supabase
        .from('location')
        .update({ points: newPoints })
        .eq('region_plantloc', localizacao);

      if (updateError) {
        console.error('Erro ao atualizar pontos:', updateError);
      }
    }

    alert('Linha removida com sucesso e pontos atualizados!');
    location.reload();
  } catch (err) {
    console.error(err);
    alert('Erro inesperado ao remover linha.');
  }
};


window.editarLinha = function(id) { window.location.href = `edit.html?id=${id}`; };

// MAPA (mantive seu código praticamente igual)
const map = L.map('map', { minZoom: 2, maxBounds: [[-90, -180], [90, 180]] }).setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors', noWrap: true }).addTo(map);
map.fitWorld();

const markersData = [
  { name: "HOR", region: "Americas", lat: -22.51, lng: -47.13},
  { name: "SIT", region: "Europe", lat: 46.922, lng: 11.951},
  { name: "AUB", region: "Americas", lat: 42.64, lng: -83.25},
  { name: "BON", region: "Europe", lat: 50.69, lng: 7.15},
  { name: "BRU", region: "Europe", lat: 46.79, lng: 11.94},
  { name: "CIN", region: "Americas", lat: 39.99, lng: -75.01},
  { name: "CON", region: "Americas", lat: 35.71, lng: -81.22},
  { name: "DAN", region: "Asia", lat: 31.99, lng: 119.57},
  { name: "FIL", region: "Europe", lat: 51.20, lng: 7.35},
  { name: "GLA", region: "Americas", lat: 36.38, lng: -86.47},
  { name: "INC", region: "Americas", lat: 38.60, lng: -86.10},
  { name: "IST", region: "Europe", lat: 40.98, lng: 28.82},
  { name: "MIL", region: "Europe", lat: 45.52, lng: 9.33},
  { name: "NAG", region: "Asia", lat: 19.10, lng: 74.73},
  { name: "PAS", region: "Americas", lat: 41.95, lng: -78.63},
  { name: "PIM", region: "Asia", lat: 18.62, lng: 73.80},
  { name: "WIS", region: "Americas", lat: 43.41, lng: -88.12},
  { name: "YIZ", region: "Asia", lat: 32.27, lng: 119.18}
];

const markers = [];
markersData.forEach(loc => {
  const marker = L.marker([loc.lat, loc.lng], { title: loc.name })
    .bindPopup(`<b>${loc.name}</b><br>Practices: 0<br><button class="btn btn-primary btn-sm" onclick="filterByLocation('${loc.name}')">Apply Filter</button>`)
    .addTo(map);
  marker.siteName = loc.name;
  marker.region = loc.region;
  markers.push(marker);
});
window.filterByLocation = function(location) {
  const el = document.getElementById('filter-location');
  if (el) { el.value = location; }
  applyFilters();
};

// PAGINAÇÃO + FETCH + FILTROS (unificados e robustos)
const rowsPerPage = 10;
let currentPage = 1;

function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str).replace(/[&<>"'`=\/]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
  })[s]);
}

function populateFilter(id, values) {
  const select = document.getElementById(id);
  if (!select) return;
  // reset options
  select.innerHTML = '<option value="">All</option>';
  Array.from(values).sort().forEach(value => {
    const option = document.createElement('option');
    option.value = value;
    option.textContent = value;
    select.appendChild(option);
  });
}

// Busca dados do Supabase e popula a tabela
async function fetchData() {
  const { data, error } = await supabase.from('submissions').select('*');
  if (error) { console.error('Erro ao buscar dados:', error.message); return; }

  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';

  const categories = new Set();
  const statuses = new Set();
  const locations = new Set();
  const countsByLocation = {};

  data.forEach(item => {
    const row = document.createElement('tr');
    row.dataset.matched = 'true';
    row.dataset.id = item.id ?? '';

    row.innerHTML = `
      <td>${escapeHtml(item.title)}</td>
      <td>${escapeHtml(item.category)}</td>
      <td>${escapeHtml(item.region_plant)}</td>
      <td>${escapeHtml(item.responsible)}</td>
      <td>${escapeHtml(item.status)}</td>
      <td>${item.file_url ? `<a href="${escapeHtml(item.file_url)}" target="_blank">Download</a>` : 'Sem arquivo'}</td>
      <td><a href="detail.html?id=${item.id}">Detail</a></td>
      <td>${escapeHtml(item.item_type)}</td>
      <td><button class="btn btn-primary btn-sm" onclick="selecionarAtividade(this)" title="Send"><i class="bi bi-cart"></i></button></td>
      <td>
        <button class="btn btn-warning btn-sm" title="Edit" onclick="editarLinha(${item.id})"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-danger btn-sm" title="Delete" onclick="removerLinha(${item.id})"><i class="bi bi-x-lg"></i></button>
      </td>
    `;
    tbody.appendChild(row);

    if (item.category) categories.add(item.category);
    if (item.status) statuses.add(item.status);
    if (item.region_plant) {
      locations.add(item.region_plant);
      countsByLocation[item.region_plant] = (countsByLocation[item.region_plant] || 0) + 1;
    }
  });

  populateFilter('filter-category', categories);
  populateFilter('filter-status', statuses);
  populateFilter('filter-location', locations);

  // Atualiza popups no mapa com contagem real
  markers.forEach(marker => {
    const site = marker.siteName;
    const total = countsByLocation[site] || 0;
    marker.bindPopup(`<b>${site}</b><br>Practices: ${total}<br><button class="btn btn-primary btn-sm" onclick="filterByLocation('${site}')">Filter Practices</button>`);
  });

  // Aplicar filtros (inicialmente todos) e renderizar a página 1
  applyFilters();
}

// Aplica filtros e marca as linhas que combinam
window.applyFilters = function() {
  const category = document.getElementById('filter-category')?.value || '';
  const status = document.getElementById('filter-status')?.value || '';
  const location = document.getElementById('filter-location')?.value || '';
  const keyword = (document.getElementById('searchInput')?.value || '').toLowerCase();

  const rows = Array.from(document.querySelectorAll('#results-table tbody tr'));
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    const cat = row.children[1]?.textContent.trim() || '';
    const loc = row.children[2]?.textContent.trim() || '';
    const stat = row.children[4]?.textContent.trim() || '';

    const matched = (!category || cat === category) &&
                    (!status || stat === status) &&
                    (!location || loc === location) &&
                    (keyword === '' || text.includes(keyword));

    row.dataset.matched = matched ? 'true' : 'false';
  });

  currentPage = 1;
  renderTablePage(currentPage);

  // Atualiza marcadores do mapa para mostrar apenas locais com resultados
  const visibleLocations = new Set(rows.filter(r => r.dataset.matched === 'true').map(r => r.children[2]?.textContent.trim()));
  markers.forEach(marker => {
    if (visibleLocations.has(marker.siteName)) marker.addTo(map); else map.removeLayer(marker);
  });
};

// Renderiza apenas as linhas correspondentes à página atual
function renderTablePage(page) {
  const allRows = Array.from(document.querySelectorAll('#results-table tbody tr'));
  const matchedRows = allRows.filter(r => r.dataset.matched === 'true');

  const totalRows = matchedRows.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));

  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;
  currentPage = page;

  // Esconder todas e mostrar apenas as do slice atual
  allRows.forEach(r => r.style.display = 'none');
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  matchedRows.slice(start, end).forEach(r => r.style.display = '');

  // Atualizar paginação
  renderPagination(totalPages);

  // Atualizar contador de linhas
  const info = document.getElementById('table-info');
  if (info) {
    const showingStart = totalRows === 0 ? 0 : start + 1;
    const showingEnd = Math.min(end, totalRows);
    info.textContent = `Displaying ${showingStart}–${showingEnd} of ${totalRows} registers`;
  }
}


function renderPagination(totalPages) {
  const container = document.getElementById('pagination');
  container.innerHTML = '';
  const ul = document.createElement('ul');
  ul.className = 'pagination';

  const createPageItem = (label, disabled, clickHandler, active=false) => {
    const li = document.createElement('li');
    li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
    const a = document.createElement('a');
    a.className = 'page-link';
    a.href = '#';
    a.innerHTML = label;
    a.addEventListener('click', (e) => {
      e.preventDefault();
      if (disabled) return;
      clickHandler();
    });
    li.appendChild(a);
    return li;
  };

  ul.appendChild(createPageItem('&laquo;', currentPage === 1, () => renderTablePage(currentPage - 1)));
  for (let i = 1; i <= totalPages; i++) {
    ul.appendChild(createPageItem(String(i), false, () => renderTablePage(i), i === currentPage));
  }
  ul.appendChild(createPageItem('&raquo;', currentPage === totalPages, () => renderTablePage(currentPage + 1)));

  container.appendChild(ul);
}

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
  fetchData();
});
</script>

<!-- Autenticação do usuário (mantive sua lógica original) -->
<script type="module">
import { createClient as createClient2 } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase2 = createClient2('https://qnxvprptwczutzojjyve.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio');

(async () => {
  try {
    const { data: { user } } = await supabase2.auth.getUser();
    if (user) {
      document.getElementById("usuario").innerText = `User: ${user.email}`;
    } else {
      // não redireciono automaticamente para facilitar testes locais; remova se quiser forçar login
      // window.location.href = "login.html";
    }
  } catch (err) {
    console.error('Erro ao obter usuário:', err);
  }
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
