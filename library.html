<!DOCTYPE html>

<html lang="pt-BR">
<head>
<link rel="icon" href="simb.ico" type="image/x-icon">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="style.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<title>Library - Best Practices Platform</title>

<style>


/* azul suave para fora do mapa */
.leaflet-container {
  background: #AAD3DF; 
}
	
	/* Layout principal em duas colunas */
.layout {
  display: flex;
  height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 200px;
  background-color: #9AB6DE;
  padding-top: 60px;
  transition: width 0.3s ease;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
}

.sidebar.collapsed {
  width: 60px;
}

.sidebar a {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  text-decoration: none;
  font-size: 18px;
  color: #fff;
  white-space: nowrap;
  transition: background-color 0.2s;
}

.sidebar a:hover {
  background-color: #575757;
}

.sidebar a span:first-child {
  width: 30px;
  text-align: center;
}

.sidebar .link-text {
  opacity: 1;
  transition: opacity 0.2s ease;
}

.sidebar.collapsed .link-text {
  opacity: 0;
  pointer-events: none;
  width: 0;
  overflow: hidden;
}

/* Conteúdo principal */
main {
  flex: 1;
  padding: 20px;
  transition: margin-left 0.3s ease;
  overflow-y: auto;
}

/* Botão para abrir sidebar */
.openbtn {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1100;
  font-size: 20px;
  cursor: pointer;
  background-color: #9AB6DE;
  color: white;
  padding: 10px 15px;
  border: none;
}

	
	body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f8;
    }
    header {
      background: #9AB6DE;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    nav {
      background: #34495e;
      padding: 0.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    nav a {
      margin: 0 1em;
      text-decoration: none;
      color: white;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    main {
      padding: 2em;
    }
   
    input[type="text"], select {
      padding: 0.5em;
      margin: 0.5em 0;
      width: 200px;
    }
  </style>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script></head>
<body>
<header>
<img alt="Best Practice Platform Logo" src="lamp_light.png" style="height:150px; background-color:transparent;"/>

<div id="usuario" style="text-align:right; padding: 0.5em; font-size: 0.9em; color:white"></div>

</header>
<!-- Botão de toggle -->
<button onclick="toggleSidebar()" class="openbtn">☰</button>

<!-- Container do layout -->
<div class="layout">
  <!-- Sidebar -->
  <div id="mySidebar" class="sidebar collapsed">
    <a href="index.html" title="Dashboard">
  <span><i class="bi bi-speedometer2 text-white"></i></span>
  <span class="link-text">Dashboard</span>
</a>

<a href="library.html" title="Library">
  <span><i class="bi bi-journals text-white"></i></span>
  <span class="link-text">Library</span>
</a>

<a href="submission.html" title="Submit">
  <span><i class="bi bi-upload text-white"></i></span>
  <span class="link-text">Submit</span>
</a>

<a href="tracker.html" title="Tracker">
  <span><i class="bi bi-graph-up-arrow text-white"></i></span>
  <span class="link-text">Tracker</span>
</a>

<a href="audit.html" title="Audit">
  <span><i class="bi bi-search text-white"></i></span>
  <span class="link-text">Audit</span>
</a>

<a href="admin.html" title="Admin">
  <span><i class="bi bi-person-gear text-white"></i></span>
  <span class="link-text">Admin</span>
</a>

<a href="login.html" title="Login">
  <span><i class="bi bi-box-arrow-in-right text-white"></i></span>
  <span class="link-text">Login</span>
</a>

   <!-- Novo botão de mensagens -->
  <a href="mail.html" title="Mensagens">
    <span><i class="bi bi-envelope-fill text-white"></i></span>
    <span class="link-text">Mensagens</span>
  </a>
	  
    <!-- Botão logout fixado no rodapé -->
<div class="logout-container">
    <a href="#" id="logoutBtn" title="Logout">
    <span><i class="bi bi-box-arrow-right text-white"></i></span>
    <span class="link-text">Logout</span>
    </a>
</div>
  </div>

<main id="mainContent">
<h2>Library</h2>
<div id="map" style="height: 350px; margin-top: 20px;"></div>

<section id="data-section">

<form class="row g-3 needs-validation" novalidate>

<div class="col-md-3">
<label class="form-label">Keywords: </label>
<input id="searchInput" class="form-control" onkeyup="applyFilters()" placeholder="Keywords..." type="text"/>
</div>

<div class="col-md-3">
<label for="filter-category" class="form-label">Category:</label>
<select id="filter-category" class="form-select" onchange="applyFilters()">	
<option value="">All</option>
</select>
</div>

<div class="col-md-3">
<label for="filter-status">Status:</label>
<select id="filter-status" class="form-select" onchange="applyFilters()">
<option value="">All</option>
</select>
</div>

<div class="col-md-3">
<label for="filter-location">Region/Site:</label>
<select id="filter-location" class="form-select" onchange="applyFilters()">
<option value="">All</option>
</select>
</div>
</form>
	
<table id="results-table" class="table table-hover">
<thead>
<tr>
<th>Title</th>
<th>Category</th>
<th>Region/Site</th>
<th>Responsible</th>
<th>Status</th>
<th>Files</th>
<th>Details</th>
<th>Type</th>
<th>Implement</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

</main>
</div>
	
<script>
function toggleSidebar() {
  const sidebar = document.getElementById("mySidebar");
  sidebar.classList.toggle("collapsed");
}
</script>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';

    const supabase = createClient('https://qnxvprptwczutzojjyve.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio');

    window.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        if (error) {
          console.error('Erro ao fazer logout:', error.message);
        } else {
          alert('Logout realizado com sucesso!');
          window.location.href = 'login.html'; // ou outra página desejada
        }
      });
    });
  </script>
	
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = 'https://qnxvprptwczutzojjyve.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  window.selecionarAtividade = async function(botao) {
    const linha = botao.closest("tr");

    // Campos visíveis na interface
    const titulo = linha.cells[0].innerText;
    const categoria = linha.cells[1].innerText;
    const localizacao = linha.cells[2].innerText;
    const responsavel = linha.cells[3].innerText;
    const status = linha.cells[4].innerText;

    // Pega o ID pelo link do botão "Detail"
    const detalhes_link = linha.cells[6].querySelector('a')?.href || '';
    const id = new URL(detalhes_link, window.location.origin).searchParams.get('id');

    if (!id) {
      alert("ID da submissão não encontrado.");
      return;
    }

    // Buscar os 4 campos adicionais diretamente do Supabase
    const { data, error } = await supabase
      .from('submissions')
      .select('description, functional_area, applicability, steps')
      .eq('id', id)
      .single();

    if (error || !data) {
      console.error("Erro ao buscar dados adicionais:", error);
      alert("Erro ao buscar dados da submissão.");
      return;
    }

    const { description, functional_area, applicability, steps } = data;

    // Inserir dados combinados na tabela atividades_selecionadas
    const { error: insertError } = await supabase
      .from('atividades_selecionadas')
      .insert([{
        titulo,
        categoria,
        localizacao,
        responsavel,
        status,
        description,
        functional_area,
        applicability,
        steps
      }]);

    if (insertError) {
      console.error("Erro ao enviar:", insertError);
      alert("Erro ao enviar atividade.");
    } else {
      alert("Atividade enviada com sucesso!");
      botao.disabled = true;
      botao.classList.remove("btn-primary");
      botao.classList.add("btn-secondary");
    }
  };

	
</script>

	
<script>
    function capitalize(str) {
      if (!str) return "";
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    const user = localStorage.getItem("username");
    const role = localStorage.getItem("userRole");
    if (user && role) {
      const formattedUser = capitalize(user);
      const formattedRole = capitalize(role);
      document.getElementById("user-info").textContent = `Logged in as: ${formattedUser} (${formattedRole})`;
    }

    document.getElementById('title-filter').addEventListener('input', filterTable);
    document.getElementById('category-filter').addEventListener('change', filterTable);

    function filterTable() {
      const title = document.getElementById('title-filter').value.toLowerCase();
      const category = document.getElementById('category-filter').value;
      const rows = document.querySelectorAll('#practices-table tbody tr');

      rows.forEach(row => {
        const titleText = row.cells[0].textContent.toLowerCase();
        const categoryText = row.cells[1].textContent;
        const matchTitle = titleText.includes(title);
        const matchCategory = category === "" || categoryText === category;
        row.style.display = matchTitle && matchCategory ? "" : "none";
      });
    }
  </script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	
<script>
const map = L.map('map', {
  minZoom: 2,
  maxBounds: [[-90, -180], [90, 180]]
}).setView([20, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors',
  noWrap: true
}).addTo(map);

map.fitWorld();

    const markersData = [
  { name: "HOR", region: "Americas", lat: -22.51, lng: -47.13},
  { name: "SIT", region: "Europe", lat: 46.922, lng: 11.951}, // Sand in Taufers, Italy
  { name: "AUB", region: "Americas", lat: 42.64, lng: -83.25}, // Auburn Hills, MI, USA
  { name: "BON", region: "Europe", lat: 50.69, lng: 7.15},     // Bonn, Germany
  { name: "BRU", region: "Europe", lat: 46.79, lng: 11.94},    // Brunico, Italy
  { name: "CIN", region: "Americas", lat: 39.99, lng: -75.01}, // Cinnaminson, NJ, USA
  { name: "CON", region: "Americas", lat: 35.71, lng: -81.22}, // Conover, NC, USA
  { name: "DAN", region: "Asia", lat: 31.99, lng: 119.57},     // Danyang, China
  { name: "FIL", region: "Europe", lat: 51.20, lng: 7.35},     // Radevormwald, Germany
  { name: "GLA", region: "Americas", lat: 36.38, lng: -86.47}, // Gallatin, TN, USA
  { name: "INC", region: "Americas", lat: 38.60, lng: -86.10}, // Dubois, IN, USA
  { name: "IST", region: "Europe", lat: 40.98, lng: 28.82},    // Istanbul, Turkey
  { name: "MIL", region: "Europe", lat: 45.52, lng: 9.33},     // Milan, Italy
  { name: "NAG", region: "Asia", lat: 19.10, lng: 74.73},      // Ahmednagar, India
  { name: "PAS", region: "Americas", lat: 41.95, lng: -78.63}, // Saint Marys
  { name: "PIM", region: "Asia", lat: 18.62, lng: 73.80},      // Pimpri, India
  { name: "WIS", region: "Americas", lat: 43.41, lng: -88.12}, // Germantown, WI, USA
  { name: "YIZ", region: "Asia", lat: 32.27, lng: 119.18}      // Yizheng, China
]
;

    const markers = [];

    markersData.forEach(loc => {
    const marker = L.marker([loc.lat, loc.lng], { title: loc.name })
      .bindPopup(`<b>${loc.name}</b><br>Practices: ${loc.practices}
        <br><button class="btn btn-primary btn-sm" onclick="filterByLocation('${loc.name}')">Apply Filter</button>`)
      .addTo(map);

    marker.siteName = loc.name;
    marker.region = loc.region;
    markers.push(marker);
  });

  // Função chamada pelo botão do popup
  window.filterByLocation = function(location) {
    document.getElementById('filter-location').value = location;
    applyFilters();
  };
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const SUPABASE_URL = 'https://qnxvprptwczutzojjyve.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

window.removerLinha = async function(id) {
  const { error } = await supabase
	.from('submissions')
	.delete()
	.eq('id', id);

  if (error) {
	alert('Erro ao remover: ' + error.message);
  } else {
	alert('Linha removida com sucesso!');
	location.reload();
  }
};

window.editarLinha = function(id) {
  window.location.href = `edit.html?id=${id}`;
}

  async function fetchData() {
  const { data, error } = await supabase.from('submissions').select('*');
  if (error) {
    console.error('Erro ao buscar dados:', error.message);
    return;
  }

  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';

  const categories = new Set();
  const statuses = new Set();
  const locations = new Set();
  const countsByLocation = {};

  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.title}</td>
      <td>${item.category}</td>
      <td>${item.region_plant}</td>
      <td>${item.responsible}</td>
      <td>${item.status}</td>
      <td>${item.file_url ? `<a href="${item.file_url}" target="_blank">Download</a>` : 'Sem arquivo'}</td>
      <td><a href="detail.html?id=${item.id}">Detail</a></td>
      <td>${item.item_type}</td>
      <td><button class="btn btn-primary btn-sm" onclick="selecionarAtividade(this)" title="Send"><i class="bi bi-cart"></i></td>
      <td>
        <button class="btn btn-warning btn-sm" title="Edit" onclick="editarLinha(${item.id})"><i class="bi bi-pencil"></i>
        <button class="btn btn-danger btn-sm" title="Delete" onclick="removerLinha(${item.id})"><i class="bi bi-x-lg"></i>
      </td>
    `;
    tbody.appendChild(row);

    if (item.category) categories.add(item.category);
    if (item.status) statuses.add(item.status);
    if (item.region_plant) {
      locations.add(item.region_plant);
      countsByLocation[item.region_plant] = (countsByLocation[item.region_plant] || 0) + 1;
    }
  });

  populateFilter('filter-category', categories);
  populateFilter('filter-status', statuses);
  populateFilter('filter-location', locations);

  // Atualiza popups no mapa com dados reais
  markers.forEach(marker => {
    const site = marker.siteName;
    const total = countsByLocation[site] || 0;
    marker.bindPopup(`
      <b>${site}</b><br>
      Practices: ${total}<br>
      <button class="btn btn-primary btn-sm" onclick="filterByLocation('${site}')">Filter Practices</button>
    `);
  });
}


  function populateFilter(id, values) {
    const select = document.getElementById(id);
    values.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
  }

 window.applyFilters = function() {
    const category = document.getElementById('filter-category').value;
    const status = document.getElementById('filter-status').value;
    const location = document.getElementById('filter-location').value;
    const keyword = document.getElementById('searchInput').value.toLowerCase();

    const rows = document.querySelectorAll('#results-table tbody tr');
    const visibleLocations = new Set();

    rows.forEach(row => {
      const [title, cat, loc, resp, stat] = row.children;
      const matchKeyword = keyword === "" || row.textContent.toLowerCase().includes(keyword);
      const show =
        matchKeyword &&
        (!category || cat.textContent === category) &&
        (!status || stat.textContent === status) &&
        (!location || loc.textContent === location);

      row.style.display = show ? '' : 'none';
      if (show) visibleLocations.add(loc.textContent);
    });

    markers.forEach(marker => {
      if (visibleLocations.has(marker.siteName)) {
        marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  };

  document.addEventListener('DOMContentLoaded', () => {
    fetchData();
  });
</script> 
	
<script>
function filterTable() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("table tbody tr");

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    const match = Array.from(cells).some(cell =>
      cell.textContent.toLowerCase().includes(input)
    );
    row.style.display = match ? "" : "none";
  });
}
</script>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient('https://qnxvprptwczutzojjyve.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueHZwcnB0d2N6dXR6b2pqeXZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MzIxMjAsImV4cCI6MjA2OTMwODEyMH0.oBi3ZBvEIBUzsaAPvYRJIhAZlJuetYVMcxFTRs_gBio');

  const { data: { user } } = await supabase.auth.getUser();

  if (user) {
    document.getElementById("usuario").innerText = `User: ${user.email}`;
  } else {
    window.location.href = "login.html"; // redireciona se não estiver logado
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>	
</section></body>
</html>
